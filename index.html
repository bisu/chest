<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<!-- FAVICON -->
<link rel="icon" type="image/png" sizes="32x32" href="public/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="public/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="public/favicon-16x16.png">
<!-- END FAVICON -->
<style type="text/css">
body{background: url("public/imgs/noise-bg4.png");}
/*img{position: absolute;}*/
.footman{position: absolute;/*background-repeat:no-repeat;border: red 1px solid*/;/*background: url(public/imgs/sprite.png) 0 0 no-repeat*/}
.tile{background:url("public/imgs/grass.png") 0 0 no-repeat;background-color: green; /*background-size:50px 50px*/; ;position: absolute;border: black 1px solid}
.sprites{position: absolute;}
.mobile-console{position: absolute;}
</style>
</head>
<body>

<!-- <script id="template-search-okres" type="text/x-template"></script> -->
<script src="libs/jquery.min.js"></script>
<script src="libs/fastclick.js"></script>
<!-- <script src="libs/mainloop.min.js"></script> -->
<script>
FastClick.attach(document.body);

//DOM
var $body = $("body");
var $doc = $(document);

//GLOBLAS
//mobile console
function mc(txt){
  var txt = txt.toString();

  if($(".mobile-console").length === 0){
    $("<div class='mobile-console'></div>").text(txt).css({
      left:"10px",
      top: 0.75*screen.height + "px"
    }).appendTo($body);       
  }else{
    $(".mobile-console").text(txt);
  }

}

//================//
//======1.. GAME PARAMS=====//
//==============//
var graphicsParams = {
  spaceLeftRight: 30,
  spaceTop: 30,
} 

var tileParams = (function(){
  var borderRad = 10;
  var width = (screen.width - 2*graphicsParams.spaceLeftRight)/8;
  var height = width;
  return {
    width: width,
    height: height,
    borderRad: borderRad
  }
})();

//Can try also this way, second answer: http://stackoverflow.com/questions/2430206/how-can-i-scale-an-image-in-a-css-sprite

var footmanParams = (function(){

  var scale = 1;

  var widthHeight = tileParams.width * scale;
  var backgroundWholeSprite = {};
  var backgroundStep = widthHeight;

  backgroundWholeSprite.width = widthHeight * 11;
  backgroundWholeSprite.height = widthHeight;

  return {
    widthHeight: widthHeight,
    backgroundWholeSprite: backgroundWholeSprite,
    backgroundStep: backgroundStep
  }
})();

var footmanFrames = (function(){

  var step = footmanParams.backgroundStep;
  var frames = {};

  frames.current = 1

  frames.currentPosition = function(){
    return -((11-this.current) * step);
  }

  frames.next = function(){
    this.current = this.current === 11 ? 1 : this.current+1;
    footman.css({
      backgroundPosition: -((11-this.current) * step) +"px 0px"
    });
  }

  frames.custom = function(frameNum){

    if( !$.isNumeric(frameNum) ){
      console.log("not a number");
      return 
    }

    //cast to int
    frameNum = parseInt(frameNum, 10); 

    if( frameNum < 0 || frameNum > 11 ){
      console.log("out of bounds");
      return 
    }

    footman.css({
      backgroundPosition: -((11-frameNum) * step) +"px 0px"
    });
  }

  frames.attack = function(){

  }

  return frames;
})();

//======1.END GAME PARAMS=====//

//===================//
//======2..MAP======//
//=================//

var sprites = [
null,//0
"public/imgs/bush.png",//1
"public/imgs/tree.png",//2
"public/imgs/bush2.png",//3
"public/imgs/rock.png",//4
"gem-link",
"gem-link"
]

;(function(){

  var $tiles = $();
  var $tile;
  var color = 1;
  var leftPos;
  var topPos = graphicsParams.spaceTop - tileParams.height;

  for(var j=0;j<8;j++){
    
    topPos = topPos + tileParams.height;
    leftPos = graphicsParams.spaceLeftRight - tileParams.width;

    for(var i=0;i<8;i++){
      leftPos = leftPos + tileParams.width;
      color = !color;
      $tile = $("<div class='tile' id='" + j + "-" + i + "'></div>").css({
        top:  topPos + "px",
        left: leftPos + "px",
        width: tileParams.width,
        height: tileParams.height
      });
      $tiles = $tiles.add($tile);
    }//inner loop end
  }//outer loop end
  $body.append($tiles);
})();


;(function(){

  //where are trees, rocks etc
  var spriteMask = [
  0,0,0,4,4,0,0,2,
  2,0,1,0,0,0,2,2,
  2,2,0,0,0,0,0,2,
  0,0,3,0,1,0,0,2,
  3,0,0,0,0,0,3,0,
  0,0,1,0,0,0,0,4,
  2,4,0,0,0,0,2,0,
  2,0,2,2,0,2,2,2
  ];

  var $tiles = $();
  var $tile;

  for(var i=0, len=spriteMask.length; i<len; i++){

    var j = Math.floor(i/8);
    var n = i%8;

    //console.log(j+"-"+n);
    if(!spriteMask[i]){
      continue;
    }

    $tile = $("<div class='sprites' id='sprites-" + j + "-" + n + "'></div>").css({
      top: $("#"+ j + "-" + n).position().top + "px",
      left: $("#"+ j + "-" + n).position().left + "px",
      width: tileParams.width,
      height: tileParams.height,
      background: "url(" + sprites[spriteMask[i]] + ") no-repeat",
      backgroundSize: tileParams.width+"px"+" "+ tileParams.width+"px",
    });
    $tiles = $tiles.add($tile);
  }

  $body.append($tiles);

})();

//make background image the size of the tile
$(".tile").css({
  backgroundSize: tileParams.width + "px" + " " + tileParams.width + "px"
})

//make corner tiles rounded
$("#0-0").css({"border-top-left-radius":tileParams.borderRad+"px"});$("#0-7").css({"border-top-right-radius":tileParams.borderRad+"px"});$("#7-0").css({"border-bottom-left-radius":tileParams.borderRad+"px"});$("#7-7").css({"border-bottom-right-radius":tileParams.borderRad+"px"});  
//======2..END MAP======//


//======================//
//======3..FOOTMAN=====//
//======================//

//TEMP
var animating = false;

//FIX move generation to html css
var footman = $("<div class='footman'></div>").css({
  width: footmanParams.widthHeight,
  height: footmanParams.widthHeight,
  background: "url(public/imgs/sprite.png) no-repeat",
  backgroundSize: footmanParams.backgroundWholeSprite.width+"px"+" "+footmanParams.backgroundWholeSprite.height+"px",
  backgroundPosition: footmanFrames.currentPosition() + "px 0px"
}).data({
  tile:[5,4]
});

var l = $("#5-4").position().left;
var t = $("#5-4").position().top;

footman.css({
  top: t,
  left: l,
}).appendTo($body);


//TEMP - attack
/*;(function (arr){

  var miliseconds = 300;
  var pointer = 0;
  var len = arr.length;

  ;(function seq(){
    footmanFrames.custom( arr[pointer] );
    pointer = pointer < len-1 ? pointer+1 : 0;
    setTimeout(seq, miliseconds);
  })();

})([1,6]);*/


$body.on("click", ".tile", function(ev){

  //check if you can go to that tile
  var targetTile = this.id.split("-").map(function(el){return parseInt(el,10)});
  var currentTile = footman.data("tile");
  if(Math.abs(targetTile[0] - currentTile[0]) > 1 || Math.abs(targetTile[1] - currentTile[1]) > 1){
    console.log("tiles too far");
    return;
  }

  //change rotation of sprite if we are facing right or left
  if(currentTile[1] > targetTile[1]){
    footman.css({transform: "scaleX(-1)"});

  }else if(currentTile[1] < targetTile[1]){
    footman.css({transform: "scaleX(1)"});

  }else{
    //do nothing - dont change rotation
  }

  //quit if we are currently animating
  if(animating){
    console.log("we are animating");
    return;
  }

  var l = $(this).position().left;
  var t = $(this).position().top;

  //we started animating switch
  animating = true;

  var inc = 0;
  (function gameOn(){
    
    if(!animating){
      return;
    }

    footmanFrames.next();

    setTimeout(gameOn, 40);
  })();  

  footman.animate({
    left:l,
    top:t
  }, 450, function(){
    animating = false;
    console.log("animation complete");

    //change data about current tile
    footman.data({tile:targetTile});
  })
});

//======3..END FOOTMAN======//
</script>
</body>
</html>